---
sudo: required
dist: trusty
language: generic

env:
  - PLAYBOOK=test.yml

before_install:
  - sudo apt-get update -qq

install:
  # install ansible
  - sudo pip install ansible

  # configure ansible
  - "{ echo '[defaults]'; echo 'roles_path = ../'; } >> ansible.cfg"

  # install dependencies from meta/main.yml
  - "read dependencies < <(cat meta/main.yml  | grep 'role:' | awk '{print $3}' | tr '\n' ' '); ansible-galaxy install $dependencies"

script:
  # check syntax
  - "ansible-playbook -i tests/inventory tests/$PLAYBOOK --syntax-check"

  # initial run
  - "ansible-playbook -i tests/inventory tests/$PLAYBOOK --connection=local --sudo"

  # check idempotence
  - "ansible-playbook -i tests/inventory tests/$PLAYBOOK --connection=local --sudo"

  # check ansible version
  - ansible --version

notifications:
  slack:
    secure: VeAkSsnYHwpFN/UPEtY94biKPLjrrHKEZ4dWKVcIkyXPWx1UZRoPiEscK/Pn0MNAq90nBNQ0ZTt8lVtHjIZkdjYOsuPAbtzG2DGXxZs5oQvVDnJh4txQXwMTatvkAvQCL8YRDvgjrxzvUur16W+SL9u9hb4El/+Oi7hLAakhvQeEFGSvTz7kNLoCjXmIYnMWM1xU5I9zHrtNQPafGtUSWtHDALM62vT1YvA5FBwoQq0CgshH4yvptpDmCbOXrb0ebVSRJNWeZTqYcrfKzq9h/S+0Nig6FIKr9Z3y6RVmOey1n09Ue8C1YY21Ag35V7t2ZXJrh5tz19WC02L95IwsysK728PSxOa8y2kJ8TVe1M40SgG28APsmvuOYyOAoV1vCmB0rkRD6NjsskUZa0txY/5/TStj//0fGC5Le9IE/7YEH3Jv+9Ml65vdBXD1FxfpNmpSzNQuwy2NStnPt0xK5vdh/gYGbfnvRm2u57st8y+AbtdYK68wPZ6OzC2sMFonljtQzB8hdij9qD6SZmE1KPNKaI4Zv5Swh8UOKeBRjIWtAmDW0MWYbfc7z+dRY8OzPXy+tX0UDV1/IQJkgejGCDW59gzQe9s3PBC46ElSDR7dmjl9NBxEpPu7nJSt1V5wXSYdn2DUbwnylaybksMjfZ1+V+8x2WAriZdr+cb6/Xc=
